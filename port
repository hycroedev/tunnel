#!/bin/bash

DB_FILE="/tmp/port_tunnels.db"
SERVER="89.168.49.205"
USER="tunnel"

mkdir -p /tmp
touch "$DB_FILE"

add_tunnel() {
  LOCAL_PORT=$1
  TMPFILE=$(mktemp)

  # reverse tunnel with random remote port (0:)
  ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
      -N -R 0:localhost:$LOCAL_PORT $USER@$SERVER >"$TMPFILE" 2>&1 &
  SSH_PID=$!

  # wait up to 5s for "Allocated port ..." message
  for i in {1..10}; do
    if grep -q "Allocated port" "$TMPFILE"; then
      break
    fi
    sleep 0.5
  done

  if grep -q "Allocated port" "$TMPFILE"; then
    REMOTE_PORT=$(grep "Allocated port" "$TMPFILE" | grep -oP '\d{4,5}' | head -n1)
    echo "$LOCAL_PORT:$REMOTE_PORT:$SSH_PID" >> "$DB_FILE"
    echo "‚úÖ tunnel ok: localhost:$LOCAL_PORT ‚ûú $SERVER:$REMOTE_PORT (pid $SSH_PID)"
  else
    echo "‚ùå tunnel failed, reason:"
    grep -v "^Warning:" "$TMPFILE"
    kill "$SSH_PID" 2>/dev/null
  fi
  rm -f "$TMPFILE"
}

stop_tunnel() {
  PORT=$1
  TMP=$(mktemp)
  FOUND=0
  while IFS=: read -r LPORT RPORT PID; do
    if [[ "$LPORT" == "$PORT" ]]; then
      kill "$PID" 2>/dev/null
      echo "üõë stopped tunnel: localhost:$LPORT (remote $SERVER:$RPORT)"
      FOUND=1
    else
      echo "$LPORT:$RPORT:$PID" >> "$TMP"
    fi
  done < "$DB_FILE"
  mv "$TMP" "$DB_FILE"
  [[ $FOUND -eq 0 ]] && echo "‚ö†Ô∏è no tunnel found for port $PORT"
}

stop_all() {
  while IFS=: read -r LPORT RPORT PID; do
    kill "$PID" 2>/dev/null
    echo "üõë killed tunnel: localhost:$LPORT (remote $SERVER:$RPORT)"
  done < "$DB_FILE"
  > "$DB_FILE"
}

list_tunnels() {
  if [[ ! -s "$DB_FILE" ]]; then
    echo "‚ÑπÔ∏è no active tunnels rn üò≠"
    return
  fi
  echo "üîÅ active tunnels:"
  while IFS=: read -r LPORT RPORT PID; do
    if ps -p "$PID" > /dev/null 2>&1; then
      echo " - $SERVER:$RPORT ‚ûú localhost:$LPORT (pid $PID)"
    else
      echo " - $SERVER:$RPORT ‚ûú localhost:$LPORT (dead ‚ùå)"
    fi
  done < "$DB_FILE"
}

reset() {
  echo "‚ö†Ô∏è this will kill ALL ssh procs + wipe DB. continue? (y/n)"
  read -r CONFIRM
  if [[ "$CONFIRM" =~ ^[Yy]$ ]]; then
    pkill -9 ssh 2>/dev/null
    > "$DB_FILE"
    echo "üßº reset done"
  else
    echo "üö´ reset cancelled"
  fi
}

print_help() {
  echo "üß™ port tunnel helper"
  echo "usage:"
  echo "  port add <local_port>     create tunnel (remote port auto-alloc)"
  echo "  port stop <local_port>    stop specific tunnel"
  echo "  port stop all             kill all tunnels"
  echo "  port list tunnels         show active tunnels"
  echo "  port reset                kill ALL ssh procs + wipe DB"
  echo "  port help                 show this help"
}

case "$1" in
  add)
    [[ -n "$2" ]] && add_tunnel "$2" || echo "usage: port add <local_port>"
    ;;
  stop)
    if [[ "$2" == "all" ]]; then
      stop_all
    elif [[ -n "$2" ]]; then
      stop_tunnel "$2"
    else
      echo "usage: port stop <local_port|all>"
    fi
    ;;
  list)
    [[ "$2" == "tunnels" ]] && list_tunnels || echo "usage: port list tunnels"
    ;;
  reset) reset ;;
  help) print_help ;;
  *) echo "‚ùì unknown command: $1"; echo "try: port help" ;;
esac
