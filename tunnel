#!/bin/bash

# ================= CONFIG =================
SERVER="181.224.60.58"
USER="tunnel"
PASSWORD="lol"          # risk ok enkil ivide password
SSH_PORT=22
LOG_DIR="/tmp/tunnel"
mkdir -p "$LOG_DIR"

# ================= COLORS =================
RED="\e[31m"
GRN="\e[32m"
YEL="\e[33m"
CYN="\e[36m"
RST="\e[0m"

# ================= CHECK =================
if [ -z "$1" ]; then
  echo -e "${YEL}Usage:${RST} tunnel <local_port>"
  exit 1
fi

LOCAL_PORT="$1"

if ! [[ "$LOCAL_PORT" =~ ^[0-9]+$ ]]; then
  echo -e "${RED}Invalid port${RST}"
  exit 1
fi

# ================= START =================
echo -e "${CYN}üöá Hycroe Tunnel${RST}"
echo -e "${YEL}Starting tunnel for localhost:${LOCAL_PORT} ...${RST}"

LOG_FILE="$LOG_DIR/$LOCAL_PORT.log"

# ================= SSH TUNNEL =================
sshpass -p "$PASSWORD" ssh \
  -o StrictHostKeyChecking=no \
  -o UserKnownHostsFile=/dev/null \
  -o ExitOnForwardFailure=yes \
  -N -f \
  -R 0:localhost:$LOCAL_PORT \
  $USER@$SERVER \
  -p $SSH_PORT \
  >"$LOG_FILE" 2>&1

sleep 1

# ================= RESULT =================
if grep -q "Allocated port" "$LOG_FILE"; then
  REMOTE_PORT=$(grep "Allocated port" "$LOG_FILE" | grep -oE '[0-9]{4,5}')
  echo -e "${GRN}‚úÖ Tunnel Active${RST}"
  echo -e "${CYN}Public:${RST} $SERVER:$REMOTE_PORT"
else
  echo -e "${RED}‚ùå Tunnel FAILED${RST}"
  echo -e "${YEL}Log:${RST}"
  cat "$LOG_FILE"
fi
